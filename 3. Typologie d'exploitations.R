#' ---
#' title: "Formation R - Typologie d'exploitations"
#' author: "Frédéric Baudron"
#' date: "19-20 Juin 2025"
#' ---


# CLEAR ENVIRONMENT-------------------------------------------------------------

rm(list = ls())


# INSTALLING NECESSARY PACKAGES-------------------------------------------------

if (!require('openxlsx')) install.packages("openxlsx")
if (!require('dplyr')) install.packages("dplyr")
if (!require('vegan')) install.packages("vegan")
if (!require('ade4')) install.packages("ade4")
if (!require('factoextra')) install.packages("factoextra")
if (!require('NbClust')) install.packages("NbClust")
if (!require('dendextend')) install.packages("dendextend")
if (!require('randomForest')) install.packages("randomForest")
if (!require('gtsummary')) install.packages("gtsummary")


# LOADING NECESSARY PACKAGES----------------------------------------------------

library(openxlsx)
library(dplyr)
library(vegan)
library(ade4)
library(factoextra)
library(NbClust)
library(dendextend)
library(randomForest)
library(gtsummary)


# SETTING UP THE DIRECTORY & LOADING THE DATA-----------------------------------

# Set your directory (where your input files are located, and where your output
# files will be save)

setwd("D:\\Mes Donnees\\1. Cirad\\Cameroun\\Formation\\")

# Load input files
data = read.xlsx("2025_06_Tableau_formation_R.xlsx", sheet = 1)

typo = data[, c(1, 9:27, 30:37)]

typo = mutate_if(typo, is.character, as.factor)
typo = mutate_if(typo, is.logical, as.factor)

typo$Educ_CM = ifelse(typo$Educ_CM == "Aucun" | typo$Educ_CM == "Education primaire",
                      "Faible", "Elevé")

typo$Educ_CM = as.factor(typo$Educ_CM)

str(typo)

typo$Sexe_CM = as.numeric(typo$Sexe_CM == "Femme")
typo$Educ_CM = as.numeric(typo$Educ_CM == "Elevé")
typo$Prop_vehicul_motor = as.numeric(typo$Prop_vehicul_motor == "TRUE")
typo$MO_salariee = as.numeric(typo$MO_salariee == "TRUE")
typo$MO_entraide = as.numeric(typo$MO_entraide == "TRUE")
typo$Appart_groupement = as.numeric(typo$Appart_groupement == "TRUE")
typo$Reprise_enfant = as.numeric(typo$Reprise_enfant == "Oui")
typo$Rev_foret = as.numeric(typo$Rev_foret == "TRUE")
typo$Chasse_peche_cueillette = as.numeric(typo$Chasse_peche_cueillette == "TRUE")
typo$Manioc_cult = as.numeric(typo$Manioc_cult == "Oui")
typo$Ign_cult = as.numeric(typo$Ign_cult == "Oui")
typo$Mais_cult = as.numeric(typo$Mais_cult == "Oui")
typo$Arachide_cult = as.numeric(typo$Arachide_cult == "Oui")
typo$Cacao_cult = as.numeric(typo$Cacao_cult == "Oui")
typo$Plantain_cult = as.numeric(typo$Plantain_cult == "Oui")
typo$Elev_porc = as.numeric(typo$Elev_porc == "TRUE")

typo = na.omit(typo)

# MATRICES OF DISSIMILARIT & PRINCIPAL COORDINATE ANALYSIS----------------------

# the scaled Euclidean dissimilarity between continuous variables
dEucs = vegdist(typo[, c("Age_CM", "Taille_famille", "Surf_cult",
                         "Nb_cult", "Rev_elev", "Rev_agri", "UBT", "Surf_jach", 
                         "Surf_louee_autres_agri", "P_sup_en_location", "P_sup_cacao"
                         )], method = "gower") 

# dissimilarity between binary variables
dBin_ppls = dist.binary(typo[, c("Sexe_CM", "Educ_CM", "Prop_vehicul_motor", "MO_salariee",
                                 "MO_entraide", "Appart_groupement", "Reprise_enfant",
                                 "Rev_foret", "Chasse_peche_cueillette", "Manioc_cult",
                                 "Ign_cult", "Mais_cult", "Arachide_cult", "Cacao_cult",
                                 "Plantain_cult", "Elev_porc"
                                 )], method = 2)


# Combine the 2 categories of dissimilarities, weighted by number of variables in each dissimilarity
dAll = (11 * dEucs^2 + 16 * dBin_ppls^2) / 27

#Transforming the matrix of dissimilarities to a matrix of distances
distAll = sqrt(2 * dAll)
pco = cmdscale(distAll, eig = TRUE, k = 10) 
# cumsum(pco$eig) / sum(pco$eig) 
barplot(pco$eig[1:20])

# choosing 4 dimensions
pco_var = pco$points[, 1:5]


# HIERARCHICHAL CLUSTER ANALYSIS------------------------------------------------

hc_pco = hclust(dist(pco_var), method = "complete")
plot(hc_pco, hang = -1)

# getting clusters
NbClust(pco_var, diss = dist(pco_var), distance = NULL, method = "complete")

grpPCO = cutree(hc_pco, k = 3)

par(mfrow = c(1, 1))
hdend = as.dendrogram(hc_pco)
hdend = color_branches(hdend, k = 3)
hdend = color_labels(hdend, k = 3)
plot(hdend)

plot(pco$points[,1], pco$points[,2], col=grpPCO)
plot(pco$points[,1], pco$points[,3], col=grpPCO)
plot(pco$points[,2], pco$points[,3], col=grpPCO)

typo$type_farm = grpPCO

typo$type_farm = as.factor(typo$type_farm)

table(typo$type_farm)

typo$type_farm = ifelse(typo$type_farm == "1", "Type 1",
                             ifelse(typo$type_farm == "2", "Type 2", "Type 3"))

typo$type_farm = as.factor(typo$type_farm)


# INTERPRETATION OF THE FARM TYPES----------------------------------------------

rf_type = randomForest(type_farm ~ ., data = typo[, -c(1)], ntree = 1500)

print(rf_type)

importance(rf_type)

varImpPlot(rf_type)


tbl = tbl_summary(typo[, -c(1)],
                  by = type_farm,
                  statistic = list(all_continuous() ~ "{mean} ({sd})",
                                   all_categorical() ~ "{p}%"),
                  missing = "no",
                  digits = all_continuous() ~ 1,
                  type = list(Surf_louee_autres_agri ~ "continuous"))

tbl

tbl = add_overall(tbl)

tbl

